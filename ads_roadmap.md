# ROADMAP: Реклама «Деньги по любви» в ответах LLM

## Цели

- Добавлять рекламный блок в конце ответа, если показатель по финансам («Деньги») < 5.
- Обеспечить частотный лимит показа (не чаще 1 раза в 24 часа на пользователя).
- Эволюция от фиксированного текста к шаблонной и динамической (LLM) персонализации.

## Текущее состояние (Этап 1)

- [x] Фиксированный рекламный блок добавляется при «Деньги» < 5.
- [x] Частотный лимит: проверка последнего показа через `UserActionLog`.
- [x] Логирование показов рекламы.
- Встройки:
  - Отправка анализа при создании нового колеса: `telegram_wheel_bot/handlers/wheel.py:166–184`.
  - Получение времени последнего показа: `telegram_wheel_bot/database/repository.py:303`.
  - Логирование действий: `telegram_wheel_bot/database/repository.py:71`.

## План развития

### Этап 2 — Шаблонный рекламный блок (без LLM)

- [ ] Набор заранее подготовленных шаблонов (бюджет/долги/инвестиции/универсальный).
- [ ] Простые правила выбора шаблона по ключевым словам и длине ответа.
- [ ] Ограничение длины рекламного блока (например, ≤ 220 символов).
- [ ] Единый метод: `append_ad_template(answer, finance_score, user_id)`.

### Этап 3 — Динамический блок от LLM

- [ ] Краткая извлекаемая тема ответа (суммаризация на 1 строку).
- [ ] Промпт для генерации рекламы с ограничениями (тон, запреты, длина, CTA).
- [ ] Валидация: фильтр запрещённых обещаний/слов; фолбэк на шаблон.
- [ ] Кэширование с ключом по теме/хэшу ответа, TTL (например, 24–72 часа).
- [ ] Единый метод: `append_ad_llm(answer, finance_score, user_id)` с фолбэком.

### Этап 4 — Метрики, A/B и расширения

- [ ] Счётчик показов/кликов (CTR) по вариантам CTA.
- [ ] A/B тестирование (например, 2–3 варианта текста и кнопок).
- [ ] Персонализация по истории (интерес к бюджету vs. инвестициям).
- [ ] Расширить показ в `/history` и сравнениях (по желанию), с теми же лимитами.
- [ ] Админ-дашборд: графики показов, CTR, распределение тем.

## Требования и ограничения

- Частотный лимит: 1 показ/24ч на пользователя.
- Запрещено: гарантии доходности, агрессивные формулировки.
- Соответствие лимиту длины сообщения Telegram (≤ 4096 символов).
- Безопасность: без утечек ключей/секретов, без логирования чувствительных данных.

## Точки встройки и функции

- Формирование и отправка анализа нового колеса: `telegram_wheel_bot/handlers/wheel.py:155–170`.
- Конвертация Markdown→HTML: `telegram_wheel_bot/services/llm_service.py:39–49`.
- Провайдеры LLM: `telegram_wheel_bot/services/llm_service.py:186–233`.
- Получение оценок: `telegram_wheel_bot/services/wheel_service.py:10–43`.
- Хранилище и логирование:
  - `get_last_user_action_time(user_id, action)` — `telegram_wheel_bot/database/repository.py:303`.
  - `log_user_action(user_id, action, ...)` — `telegram_wheel_bot/database/repository.py:71`.

## Риски и меры

- Нерелевантность текста — смягчается шаблонами/валидацией и фолбэком.
- Переполнение сообщения — ограничение длины рекламы и усечение.
- Спам — частотный лимит и возможность отключения для админов.

## Тестирование

- Юнит: выбор шаблонов по ключевым словам; частотный лимит; валидация LLM.
- Интеграция: сквозной показ рекламы при «Деньги» < 5.
- E2E: ручная проверка в Telegram, длина и кликабельность кнопки.

## Пример CTA (фиксированный)

- Текст: «Канал «Деньги по любви» — про финансы и инвестиции от финансового советника Лены Яковлевой @dengipolyubvi. Подписывайтесь: https://t.me/dengipolyubvi».
- Кнопка: «Деньги по любви» → `https://t.me/dengipolyubvi`.

## Мини-план релизов

- v0.1 (выпущено): Этап 1 — фиксированный блок + частотный лимит.
- v0.2: Этап 2 — шаблоны + правила, ограничение длины.
- v0.3: Этап 3 — LLM-генерация + валидация + кэш.
- v0.4: Этап 4 — метрики, A/B, персонализация, расширения.

