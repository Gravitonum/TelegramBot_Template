# Инструкция по развертыванию WheelOfLifeBot

## Требования

- Docker и Docker Compose установлены на системе
- Порты 3150 свободен (или измените порт в docker-compose.yml)
- Файл `.env` с необходимыми переменными окружения

## Проверка портов

Перед запуском убедитесь, что порт 3150 свободен:

**Windows:**
```powershell
netstat -ano | findstr "LISTENING" | findstr ":3150"
```

**Linux/Mac:**
```bash
netstat -tuln | grep 3150
# или
lsof -i :3150
```

Если порт занят, измените порт в `docker-compose.yml`:
```yaml
ports:
  - "НОВЫЙ_ПОРТ:3150"
```

## Подготовка к запуску

1. **Создайте файл `.env` в корне проекта** с необходимыми переменными окружения:
```bash
# Пример содержимого .env файла
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_TOKEN=ваш_токен_бота  # альтернативное имя переменной
OLLAMA_URL=http://192.168.0.165:11434
OLLAMA_MODEL=hhao/qwen2.5-coder-tools:32b
ADMIN_IDS=123456789,987654321
LOG_LEVEL=INFO
```

**Важно:** Файл `.env` должен содержать как минимум `TELEGRAM_BOT_TOKEN` или `TELEGRAM_TOKEN` для работы бота.

2. **Создайте директорию для данных базы данных** (если её нет):
```bash
mkdir -p data
```

3. **Если у вас уже есть база данных**, переместите её в директорию `data`:
```bash
# Windows (PowerShell)
Move-Item wheel_of_life.db data/wheel_of_life.db

# Linux/Mac
mv wheel_of_life.db data/wheel_of_life.db
```

4. **Убедитесь, что директория `wheels` существует** (для хранения изображений колес):
```bash
mkdir -p wheels
```

## Запуск сервисов

В docker-compose.yml настроены два сервиса:
- **bot** - Telegram бот (основное приложение)
- **admin-panel** - Административная панель (веб-интерфейс на порту 3150)

### Первый запуск

```bash
# Сборка и запуск всех контейнеров
docker-compose up -d --build

# Просмотр логов бота
docker-compose logs -f bot

# Просмотр логов админ-панели
docker-compose logs -f admin-panel

# Просмотр логов всех сервисов
docker-compose logs -f
```

### Последующие запуски

```bash
# Запуск всех существующих контейнеров
docker-compose up -d

# Остановка всех контейнеров
docker-compose down

# Перезапуск всех контейнеров
docker-compose restart

# Перезапуск конкретного сервиса
docker-compose restart bot
docker-compose restart admin-panel
```

## Обновление приложения

При обновлении версии приложения база данных **НЕ будет перезатираться**, так как она хранится в volume `./data:/app/data`.

Процесс обновления:

```bash
# 1. Остановите контейнеры
docker-compose down

# 2. Обновите код (git pull или другие способы)

# 3. Пересоберите и запустите контейнеры
docker-compose up -d --build

# 4. Проверьте логи
docker-compose logs -f bot
docker-compose logs -f admin-panel
```

## Проверка работоспособности

### Проверка бота

После запуска проверьте логи бота:
```bash
docker-compose logs bot
```

Бот должен запуститься и начать отвечать на команды в Telegram. Проверьте работу командой `/start` в Telegram.

### Проверка админ-панели

После запуска откройте в браузере:
```
http://localhost:3150
```

Должна открыться административная панель.

## Структура данных

Данные хранятся на хосте в следующих директориях:

- `./data/` - база данных SQLite (`wheel_of_life.db`)
- `./wheels/` - изображения колес жизни

Эти директории монтируются в контейнер, поэтому данные сохраняются между перезапусками и обновлениями.

## Устранение проблем

### Бот не запускается

1. Проверьте логи:
```bash
docker-compose logs bot
```

2. Убедитесь, что файл `.env` существует и содержит `TELEGRAM_BOT_TOKEN` или `TELEGRAM_TOKEN`:
```bash
# Проверка наличия файла
ls -la .env  # Linux/Mac
dir .env     # Windows
```

3. Проверьте, что токен бота правильный и бот зарегистрирован в Telegram

4. Убедитесь, что директория `data` существует и доступна для записи

### Админ-панель не запускается

1. Проверьте логи:
```bash
docker-compose logs admin-panel
```

2. Проверьте, что порт 3150 не занят другим приложением

3. Убедитесь, что директория `data` существует и доступна для записи

### База данных не найдена

Если база данных не найдена, она будет создана автоматически при первом запуске. Убедитесь, что:
- Директория `data` существует
- У контейнера есть права на запись в директорию `data`

### Переменные окружения не загружаются

Если переменные окружения не загружаются:
1. Убедитесь, что файл `.env` существует в корне проекта
2. Проверьте синтаксис файла `.env` (формат: `KEY=value`, без пробелов вокруг `=`)
3. Перезапустите контейнеры:
```bash
docker-compose down
docker-compose up -d
```

### Проблемы с правами доступа (Linux/Mac)

Если возникают проблемы с правами доступа:
```bash
sudo chown -R $USER:$USER data wheels
chmod -R 755 data wheels
```

## Остановка и удаление

### Остановка без удаления данных
```bash
docker-compose down
```

### Полное удаление (включая данные)
```bash
# ВНИМАНИЕ: Это удалит все данные!
docker-compose down -v
rm -rf data wheels
```

## Мониторинг

### Просмотр статуса контейнеров
```bash
docker-compose ps
```

### Просмотр использования ресурсов
```bash
docker stats wheeloflife-bot wheeloflife-admin
```

### Просмотр логов в реальном времени
```bash
# Логи бота
docker-compose logs -f bot

# Логи админ-панели
docker-compose logs -f admin-panel

# Логи всех сервисов
docker-compose logs -f
```

## Резервное копирование

Рекомендуется регулярно создавать резервные копии базы данных:

```bash
# Создание резервной копии
cp data/wheel_of_life.db data/wheel_of_life.db.backup.$(date +%Y%m%d_%H%M%S)

# Восстановление из резервной копии
cp data/wheel_of_life.db.backup.20240101_120000 data/wheel_of_life.db
```

## Переменные окружения

### Обязательные переменные (в файле `.env`):

- `TELEGRAM_BOT_TOKEN` или `TELEGRAM_TOKEN` - токен Telegram бота (обязательно)
- `OLLAMA_URL` - URL сервера Ollama (по умолчанию: `http://192.168.0.165:11434`)
- `OLLAMA_MODEL` - модель Ollama для анализа (по умолчанию: `hhao/qwen2.5-coder-tools:32b`)
- `ADMIN_IDS` - список ID администраторов через запятую (опционально)
- `LOG_LEVEL` - уровень логирования (по умолчанию: `INFO`)

### Переменные, устанавливаемые в `docker-compose.yml`:

- `DATABASE_URL` - путь к базе данных SQLite (по умолчанию: `sqlite:////app/data/wheel_of_life.db`)
- `ADMIN_PORT` - порт для Flask приложения (по умолчанию: `3150`)
- `WHEELS_DIR` - директория для хранения изображений колес (по умолчанию: `/app/wheels`)

**Важно:** Все переменные из файла `.env` автоматически загружаются в контейнеры через `env_file: - .env` в docker-compose.yml.

## Дополнительная информация

- Оба контейнера настроены на автоматический перезапуск при сбое (`restart: unless-stopped`)
- База данных хранится в директории `./data` на хосте, что обеспечивает сохранность данных при обновлениях
- Изображения колес хранятся в директории `./wheels` на хосте
- Файл `.env` автоматически загружается в оба контейнера, но не копируется в образ (безопасность)
- Бот и админ-панель используют одну и ту же базу данных через общий volume

