# Инструкция по развертыванию WheelOfLifeBot Admin Panel

## Требования

- Docker и Docker Compose установлены на системе
- Порты 3150 свободен (или измените порт в docker-compose.yml)

## Проверка портов

Перед запуском убедитесь, что порт 3150 свободен:

**Windows:**
```powershell
netstat -ano | findstr "LISTENING" | findstr ":3150"
```

**Linux/Mac:**
```bash
netstat -tuln | grep 3150
# или
lsof -i :3150
```

Если порт занят, измените порт в `docker-compose.yml`:
```yaml
ports:
  - "НОВЫЙ_ПОРТ:3150"
```

## Подготовка к запуску

1. **Создайте директорию для данных базы данных** (если её нет):
```bash
mkdir -p data
```

2. **Если у вас уже есть база данных**, переместите её в директорию `data`:
```bash
# Windows (PowerShell)
Move-Item wheel_of_life.db data/wheel_of_life.db

# Linux/Mac
mv wheel_of_life.db data/wheel_of_life.db
```

3. **Убедитесь, что директория `wheels` существует** (для хранения изображений колес):
```bash
mkdir -p wheels
```

## Запуск сервиса

### Первый запуск

```bash
# Сборка и запуск контейнера
docker-compose up -d --build

# Просмотр логов
docker-compose logs -f admin-panel
```

### Последующие запуски

```bash
# Запуск существующего контейнера
docker-compose up -d

# Остановка контейнера
docker-compose down

# Перезапуск контейнера
docker-compose restart
```

## Обновление приложения

При обновлении версии приложения база данных **НЕ будет перезатираться**, так как она хранится в volume `./data:/app/data`.

Процесс обновления:

```bash
# 1. Остановите контейнер
docker-compose down

# 2. Обновите код (git pull или другие способы)

# 3. Пересоберите и запустите контейнер
docker-compose up -d --build

# 4. Проверьте логи
docker-compose logs -f admin-panel
```

## Проверка работоспособности

После запуска откройте в браузере:
```
http://localhost:3150
```

Должна открыться административная панель.

## Структура данных

Данные хранятся на хосте в следующих директориях:

- `./data/` - база данных SQLite (`wheel_of_life.db`)
- `./wheels/` - изображения колес жизни

Эти директории монтируются в контейнер, поэтому данные сохраняются между перезапусками и обновлениями.

## Устранение проблем

### Контейнер не запускается

1. Проверьте логи:
```bash
docker-compose logs admin-panel
```

2. Проверьте, что порт не занят другим приложением

3. Убедитесь, что директория `data` существует и доступна для записи

### База данных не найдена

Если база данных не найдена, она будет создана автоматически при первом запуске. Убедитесь, что:
- Директория `data` существует
- У контейнера есть права на запись в директорию `data`

### Проблемы с правами доступа (Linux/Mac)

Если возникают проблемы с правами доступа:
```bash
sudo chown -R $USER:$USER data wheels
chmod -R 755 data wheels
```

## Остановка и удаление

### Остановка без удаления данных
```bash
docker-compose down
```

### Полное удаление (включая данные)
```bash
# ВНИМАНИЕ: Это удалит все данные!
docker-compose down -v
rm -rf data wheels
```

## Мониторинг

### Просмотр статуса контейнера
```bash
docker-compose ps
```

### Просмотр использования ресурсов
```bash
docker stats wheeloflife-admin
```

### Просмотр логов в реальном времени
```bash
docker-compose logs -f admin-panel
```

## Резервное копирование

Рекомендуется регулярно создавать резервные копии базы данных:

```bash
# Создание резервной копии
cp data/wheel_of_life.db data/wheel_of_life.db.backup.$(date +%Y%m%d_%H%M%S)

# Восстановление из резервной копии
cp data/wheel_of_life.db.backup.20240101_120000 data/wheel_of_life.db
```

## Переменные окружения

Текущие переменные окружения (можно изменить в `docker-compose.yml`):

- `DATABASE_URL` - путь к базе данных SQLite (по умолчанию: `sqlite:////app/data/wheel_of_life.db`)
- `ADMIN_PORT` - порт для Flask приложения (по умолчанию: `3150`)

## Дополнительная информация

- Контейнер настроен на автоматический перезапуск при сбое (`restart: unless-stopped`)
- База данных хранится в директории `./data` на хосте, что обеспечивает сохранность данных при обновлениях
- Изображения колес хранятся в директории `./wheels` на хосте

