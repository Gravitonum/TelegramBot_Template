"""
–®–∞–±–ª–æ–Ω Telegram-–±–æ—Ç–∞ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤.
–û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
"""

import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ParseMode
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
from telegram_wheel_bot.handlers.wheel import build_conversation as wheel_conversation
from telegram_wheel_bot.handlers.history import history_cmd, build_callbacks as history_callbacks
from telegram_wheel_bot.handlers.admin import clear_cmd
from telegram_wheel_bot.handlers.clean import build_clean_handlers
from telegram_wheel_bot.database import init_db as wheel_init_db
from telegram_wheel_bot.main import ensure_storage as wheel_ensure_storage

# –ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤ telegram
from app.core.config import settings

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=getattr(logging, settings.LOG_LEVEL.upper()),
)
logger = logging.getLogger(__name__)


async def setup_bot_commands(application):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –≤ –º–µ–Ω—é."""
    commands = [
        ("start", "–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º"),
        ("about", "–û –±–æ—Ç–µ"),
        ("build_wheel", "–ù–∞—á–∞—Ç—å –Ω–æ–≤–æ–µ –∫–æ–ª–µ—Å–æ"),
        ("history", "–ò—Å—Ç–æ—Ä–∏—è –∫–æ–ª–µ—Å"),
        ("clean", "–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–µ—Å–∞ –∏–ª–∏ –≤—Å–µ—Ö –∫–æ–ª–µ—Å"),
        # –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –∑–¥–µ—Å—å –ø–æ —à–∞–±–ª–æ–Ω—É: ("command_name", "–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã")
    ]
    try:
        await application.bot.set_my_commands(commands)
        logger.info("–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞: {e}")


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {update.effective_user.id} –∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–º–∞–Ω–¥—É /start")

    keyboard = [
        [InlineKeyboardButton("–û –±–æ—Ç–µ", callback_data="about")],
        # –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∑–¥–µ—Å—å –ø–æ —à–∞–±–ª–æ–Ω—É: [InlineKeyboardButton("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏", callback_data="callback_name")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    welcome_message = (
        "–ü—Ä–∏–≤–µ—Ç! üëã\n"
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç \"–ö–æ–ª–µ—Å–æ –∂–∏–∑–Ω–∏!\"\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."
    )

    await update.message.reply_text(welcome_message, reply_markup=reply_markup)


async def about(update, context: ContextTypes.DEFAULT_TYPE) -> None:
    about_text = (
        "<b>üìä Wheel of Life Bot ‚Äî –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã</b>\n\n"
        "- –ë–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å 8 —Å—Ñ–µ—Ä –∂–∏–∑–Ω–∏ –∏ –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å: –°–µ–º—å—è, –î—Ä—É–∑—å—è, –ó–¥–æ—Ä–æ–≤—å–µ, –•–æ–±–±–∏, –î–µ–Ω—å–≥–∏, –û—Ç–¥—ã—Ö, –õ–∏—á–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ, –†–∞–±–æ—Ç–∞/–±–∏–∑–Ω–µ—Å.\n"
        "- –ö–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—Ü–µ–Ω–∏–≤–∞–µ—à—å –æ—Ç 1 –¥–æ 10; –±–æ—Ç —Å—Ç—Ä–æ–∏—Ç –¥–∏–∞–≥—Ä–∞–º–º—É ‚Äò–∫–æ–ª–µ—Å–∞‚Äô –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Ç–∫–∏–π AI-–∞–Ω–∞–ª–∏–∑.\n"
        "- –í ¬´–ö–æ–ª–µ—Å–µ –∂–∏–∑–Ω–∏¬ª –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–∞—è ¬´—É—Å–ø–µ—à–Ω–æ—Å—Ç—å¬ª, –∞ —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ –∏ –æ—â—É—â–µ–Ω–∏–µ, —á—Ç–æ –≤—Å—ë –∏–¥—ë—Ç —Ç–∞–∫, –∫–∞–∫ —Ç—ã —Ö–æ—á–µ—à—å.\n"        
        "- 1‚Äì2 ‚Äî ¬´–ö—Ä–∏—Ç–∏—á–Ω–æ –ø–ª–æ—Ö–æ¬ª. –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –≤—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å, –æ—â—É—â–µ–Ω–∏–µ —Ç—É–ø–∏–∫–∞.\n"        
        "- 3‚Äì4 ‚Äî ¬´–°–ª–∞–±–æ–µ –º–µ—Å—Ç–æ¬ª. –ß—Ç–æ‚Äë—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç–µ–±—è —è–≤–Ω–æ –Ω–µ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç; –º–Ω–æ–≥–æ –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏.\n"        
        "- 5‚Äì6 ‚Äî ¬´–ù–æ—Ä–º, –Ω–æ –±–µ–∑ –∫–∞–π—Ñ–∞¬ª. –¢–µ—Ä–ø–∏–º–æ, –µ—Å—Ç—å –∏ –ø–ª—é—Å—ã, –∏ –º–∏–Ω—É—Å—ã, –º–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —É–ª—É—á—à–∏—Ç—å.\n"        
        "- 7‚Äì8 ‚Äî ¬´–•–æ—Ä–æ—à–æ/—Å—Ç–∞–±–∏–ª—å–Ω–æ¬ª. –í —Ü–µ–ª–æ–º –¥–æ–≤–æ–ª–µ–Ω, –∑–∞–¥–∞—á–∏ —Ä–µ—à–∞—é—Ç—Å—è, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –ª–æ–º–∞—é—Ç –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É.\n"        
        "- 9‚Äì10 ‚Äî ¬´–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ/–ø–æ—á—Ç–∏ –∏–¥–µ–∞–ª¬ª. –¢—ã —Ä–µ–∞–ª—å–Ω–æ –¥–æ–≤–æ–ª–µ–Ω, –≤—Å—ë –≤—ã—Å—Ç—Ä–æ–µ–Ω–æ –≤ –¥—É—Ö–µ —Ç–≤–æ–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π, —Ö–æ—á–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å.\n\n"        
        "<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã</b>\n"
        "- /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫—Ä–∞—Ç–∫–æ–µ –º–µ–Ω—é\n"
        "- /about ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞\n"
        "- /build_wheel ‚Äî –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤–æ–µ –∫–æ–ª–µ—Å–æ\n"
        "- /history ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é\n"
        "- /clean ‚Äî —É–¥–∞–ª–∏—Ç—å –æ–¥–Ω–æ –∫–æ–ª–µ—Å–æ –∏–ª–∏ –≤—Å–µ\n"
        "- /compare ‚Äî —Å—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–æ–ª–µ—Å–æ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º\n\n"
        "<b>–ö–∞–∫ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–ª–µ—Å–æ</b>\n"
        "- –í—ã–±–∏—Ä–∞–µ—à—å –º–µ—Å—è—Ü –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–µ—Ö, –≥–¥–µ –µ—â–µ –Ω–µ—Ç –∫–æ–ª–µ—Å–∞\n"
        "- –û—Ü–µ–Ω–∏–≤–∞–µ—à—å –∫–∞–∂–¥—É—é –∏–∑ 8 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ 1‚Äì10\n"
        "- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ü–µ–Ω–∫–∏, —Å—Ç—Ä–æ–∏—Ç –¥–∏–∞–≥—Ä–∞–º–º—É, –¥–æ–±–∞–≤–ª—è–µ—Ç AI-–∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –∫ –∏—Å—Ç–æ—Ä–∏–∏ (/history)\n\n"
        "<b>–ò—Å—Ç–æ—Ä–∏—è –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä</b>\n"
        "- –í /history –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–≤–æ–∏—Ö –∫–æ–ª–µ—Å —Å –¥–∞—Ç–∞–º–∏\n"
        "- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–æ–ª–µ—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑\n"
        "- –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç ‚Äò–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–µ –∫–æ–ª–µ—Å–æ‚Äô –¥–ª—è –∫–æ–º–∞–Ω–¥—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è\n\n"
        "<b>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤</b>\n"
        "- –í –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–Ω–æ–ø–∫–∞ ‚Äò–°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º‚Äô\n"
        "- –ö–æ–º–∞–Ω–¥–∞ /compare —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç ‚Äò–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–µ –∫–æ–ª–µ—Å–æ‚Äô —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–º –º–µ—Å—è—Ü–µ–º; –µ—Å–ª–∏ –º–µ—Å—è—Ü —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç\n"
        "- –ï—Å–ª–∏ ‚Äò–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ –∫–æ–ª–µ—Å–æ‚Äô –Ω–µ –∑–∞–¥–∞–Ω–æ, –±–æ—Ç –ø–æ–¥–±–µ—Ä–µ—Ç –±–ª–∏–∂–∞–π—à—É—é –ø–∞—Ä—É\n\n"
        "<b>–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</b>\n"
        "- /clean ‚Äî —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∫–æ–ª–µ—Å–æ –∏–ª–∏ –≤—Å–µ\n"
        "- –ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ; –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ\n\n"
        "<b>AI-–∞–Ω–∞–ª–∏–∑</b>\n"
        "- –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–π LLM –ø–æ —Ç–≤–æ–∏–º –æ—Ü–µ–Ω–∫–∞–º –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ Telegram\n\n"
        "<b>–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</b>\n"
        "- –û—Ü–µ–Ω–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ; –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –≤ –ø–∞–ø–∫–µ –∫–æ–ª–µ—Å\n\n"
        "–í–µ—Ä—Å–∏—è: 0.1.0\n"
        "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –°–µ—Ä–≥–µ–π –†–æ–¥–∏–æ–Ω–æ–≤"
    )
    user = getattr(update, "effective_user", None) or getattr(update, "from_user", None)
    user_id = getattr(user, "id", None)
    if user_id is not None:
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–º–∞–Ω–¥—É /about")
    msg = getattr(update, "message", None)
    if msg:
        await msg.reply_text(about_text, parse_mode=ParseMode.HTML)
        return
    chat = getattr(update, "effective_chat", None)
    chat_id = getattr(chat, "id", None)
    if chat_id is not None:
        await context.bot.send_message(chat_id=chat_id, text=about_text, parse_mode=ParseMode.HTML)


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ inline-–∫–Ω–æ–ø–∫–∏."""
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id
    callback_data = query.data

    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É: {callback_data}")

    if callback_data == "about":
        about_text = (
            "<b>üìä Wheel of Life Bot ‚Äî –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã</b>\n\n"
            "- –ë–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å 8 —Å—Ñ–µ—Ä –∂–∏–∑–Ω–∏ –∏ –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å: –°–µ–º—å—è, –î—Ä—É–∑—å—è, –ó–¥–æ—Ä–æ–≤—å–µ, –•–æ–±–±–∏, –î–µ–Ω—å–≥–∏, –û—Ç–¥—ã—Ö, –õ–∏—á–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ, –†–∞–±–æ—Ç–∞/–±–∏–∑–Ω–µ—Å.\n"
            "- –ö–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—Ü–µ–Ω–∏–≤–∞–µ—à—å –æ—Ç 1 –¥–æ 10; –±–æ—Ç —Å—Ç—Ä–æ–∏—Ç –¥–∏–∞–≥—Ä–∞–º–º—É ‚Äò–∫–æ–ª–µ—Å–∞‚Äô –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Ç–∫–∏–π AI-–∞–Ω–∞–ª–∏–∑.\n"
            "- –í ¬´–ö–æ–ª–µ—Å–µ –∂–∏–∑–Ω–∏¬ª –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–∞—è ¬´—É—Å–ø–µ—à–Ω–æ—Å—Ç—å¬ª, –∞ —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ –∏ –æ—â—É—â–µ–Ω–∏–µ, —á—Ç–æ –≤—Å—ë –∏–¥—ë—Ç —Ç–∞–∫, –∫–∞–∫ —Ç—ã —Ö–æ—á–µ—à—å.\n"        
            "- 1‚Äì2 ‚Äî ¬´–ö—Ä–∏—Ç–∏—á–Ω–æ –ø–ª–æ—Ö–æ¬ª. –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –≤—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å, –æ—â—É—â–µ–Ω–∏–µ —Ç—É–ø–∏–∫–∞.\n"        
            "- 3‚Äì4 ‚Äî ¬´–°–ª–∞–±–æ–µ –º–µ—Å—Ç–æ¬ª. –ß—Ç–æ‚Äë—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç–µ–±—è —è–≤–Ω–æ –Ω–µ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç; –º–Ω–æ–≥–æ –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏.\n"        
            "- 5‚Äì6 ‚Äî ¬´–ù–æ—Ä–º, –Ω–æ –±–µ–∑ –∫–∞–π—Ñ–∞¬ª. –¢–µ—Ä–ø–∏–º–æ, –µ—Å—Ç—å –∏ –ø–ª—é—Å—ã, –∏ –º–∏–Ω—É—Å—ã, –º–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —É–ª—É—á—à–∏—Ç—å.\n"        
            "- 7‚Äì8 ‚Äî ¬´–•–æ—Ä–æ—à–æ/—Å—Ç–∞–±–∏–ª—å–Ω–æ¬ª. –í —Ü–µ–ª–æ–º –¥–æ–≤–æ–ª–µ–Ω, –∑–∞–¥–∞—á–∏ —Ä–µ—à–∞—é—Ç—Å—è, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –ª–æ–º–∞—é—Ç –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É.\n"        
            "- 9‚Äì10 ‚Äî ¬´–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ/–ø–æ—á—Ç–∏ –∏–¥–µ–∞–ª¬ª. –¢—ã —Ä–µ–∞–ª—å–Ω–æ –¥–æ–≤–æ–ª–µ–Ω, –≤—Å—ë –≤—ã—Å—Ç—Ä–æ–µ–Ω–æ –≤ –¥—É—Ö–µ —Ç–≤–æ–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π, —Ö–æ—á–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å.\n\n"        
            "<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã</b>\n"
            "- /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫—Ä–∞—Ç–∫–æ–µ –º–µ–Ω—é\n"
            "- /about ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞\n"
            "- /build_wheel ‚Äî –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤–æ–µ –∫–æ–ª–µ—Å–æ\n"
            "- /history  ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é\n"
            "- /clean ‚Äî —É–¥–∞–ª–∏—Ç—å –æ–¥–Ω–æ –∫–æ–ª–µ—Å–æ –∏–ª–∏ –≤—Å–µ\n"
            "- /compare ‚Äî —Å—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–æ–ª–µ—Å–æ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º\n\n"
            "<b>–ö–∞–∫ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–ª–µ—Å–æ</b>\n"
            "- –í—ã–±–∏—Ä–∞–µ—à—å –º–µ—Å—è—Ü –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–µ—Ö, –≥–¥–µ –µ—â–µ –Ω–µ—Ç –∫–æ–ª–µ—Å–∞\n"
            "- –û—Ü–µ–Ω–∏–≤–∞–µ—à—å –∫–∞–∂–¥—É—é –∏–∑ 8 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ 1‚Äì10\n"
            "- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ü–µ–Ω–∫–∏, —Å—Ç—Ä–æ–∏—Ç –¥–∏–∞–≥—Ä–∞–º–º—É, –¥–æ–±–∞–≤–ª—è–µ—Ç AI-–∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –∫ –∏—Å—Ç–æ—Ä–∏–∏ (/history)\n\n"
            "<b>–ò—Å—Ç–æ—Ä–∏—è –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä</b>\n"
            "- –í /history –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–≤–æ–∏—Ö –∫–æ–ª–µ—Å —Å –¥–∞—Ç–∞–º–∏\n"
            "- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–æ–ª–µ—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑\n"
            "- –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç ‚Äò–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–µ –∫–æ–ª–µ—Å–æ‚Äô –¥–ª—è –∫–æ–º–∞–Ω–¥—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è\n\n"
            "<b>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤</b>\n"
            "- –í –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–Ω–æ–ø–∫–∞ ‚Äò–°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º‚Äô\n"
            "- –ö–æ–º–∞–Ω–¥–∞ /compare —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç ‚Äò–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–µ‚Äô —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–º –º–µ—Å—è—Ü–µ–º; –µ—Å–ª–∏ –º–µ—Å—è—Ü —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç\n"
            "- –ï—Å–ª–∏ ‚Äò–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–µ‚Äô –Ω–µ –∑–∞–¥–∞–Ω–æ, –±–æ—Ç –ø–æ–¥–±–µ—Ä–µ—Ç –±–ª–∏–∂–∞–π—à—É—é –ø–∞—Ä—É\n\n"
            "<b>–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</b>\n"
            "- /clean ‚Äî —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∫–æ–ª–µ—Å–æ –∏–ª–∏ –≤—Å–µ\n"
            "- –ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ; –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ\n\n"
            "<b>AI-–∞–Ω–∞–ª–∏–∑</b>\n"
            "- –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–π LLM –ø–æ —Ç–≤–æ–∏–º –æ—Ü–µ–Ω–∫–∞–º –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ Telegram\n\n"
            "<b>–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</b>\n"
            "- –û—Ü–µ–Ω–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ; –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –≤ –ø–∞–ø–∫–µ –∫–æ–ª–µ—Å\n\n"
            "–í–µ—Ä—Å–∏—è: 0.1.0\n"
            "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –°–µ—Ä–≥–µ–π –†–æ–¥–∏–æ–Ω–æ–≤"
        )
        await query.message.reply_text(about_text, parse_mode=ParseMode.HTML)
    # –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ –∑–¥–µ—Å—å –ø–æ —à–∞–±–ª–æ–Ω—É:
    # elif callback_data == "your_callback_name":
    #     await your_function_name(query, context)


async def setup_bot(application):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞."""
    wheel_init_db()
    wheel_ensure_storage()
    await setup_bot_commands(application)
    logger.info("–ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")


def main() -> None:
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞."""
    if not settings.TELEGRAM_BOT_TOKEN:
        logger.error("TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")
        return

    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = ApplicationBuilder().token(settings.TELEGRAM_BOT_TOKEN).build()

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("about", about))
    application.add_handler(CommandHandler("history", history_cmd))
    application.add_handler(MessageHandler(filters.Regex(r"^/–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å_–∏—Å—Ç–æ—Ä–∏—é$"), history_cmd))
    for h in history_callbacks():
        application.add_handler(h)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã /clean
    logger.info("Registering clean handlers...")
    clean_handlers = build_clean_handlers()
    for h in clean_handlers:
        application.add_handler(h)
        logger.info(f"Registered clean handler: {type(h).__name__}")
    
    application.add_handler(CommandHandler("clear", clear_cmd))
    application.add_handler(MessageHandler(filters.Regex(r"^/Clear$"), clear_cmd))
    application.add_handler(wheel_conversation())

    # –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –∑–¥–µ—Å—å –ø–æ —à–∞–±–ª–æ–Ω—É:
    # application.add_handler(CommandHandler("your_command", your_function_name))

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ inline-–∫–Ω–æ–ø–æ–∫
    application.add_handler(CallbackQueryHandler(button_handler))

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –æ—à–∏–±–æ–∫
    async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏—Ö –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö."""
        logger.error(msg="–í—ã–∑–≤–∞–Ω –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ", exc_info=context.error)

    application.add_error_handler(error_handler)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
    application.post_init = setup_bot

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ long polling
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == "__main__":
    main()
